openapi: 3.0.3
info:
  title: Nudlers Finance API
  description: |
    API for managing personal finance transactions, budgets, and bank/credit card scraping.
    
    ## Transaction Types
    Transactions can be of two types:
    - `credit_card` - Credit card transactions from vendors like visaCal, max, isracard, amex
    - `bank` - Bank account transactions from vendors like hapoalim, leumi, mizrahi, discount
    
    Use the `transactionType` query parameter to filter transactions by type.
  version: 1.0.0
  contact:
    name: Nudlers
  license:
    name: MIT

servers:
  - url: /api
    description: API Server

tags:
  - name: Transactions
    description: Transaction management (credit cards and bank accounts)
  - name: Categories
    description: Category management and categorization
  - name: Budgets
    description: Budget management
  - name: Scraping
    description: Bank and credit card scraping
  - name: Credentials
    description: Account credentials management
  - name: Settings
    description: Application settings
  - name: Reports
    description: Financial reports and summaries
  - name: WhatsApp
    description: WhatsApp notification service

paths:
  /transactions:
    get:
      tags:
        - Transactions
      summary: List transactions
      description: |
        Retrieve transactions with optional filtering by type, date range, vendor, etc.
        Default returns all transactions (both bank and credit card).
      parameters:
        - name: transactionType
          in: query
          description: Filter by transaction type
          schema:
            type: string
            enum: [all, bank, credit_card]
            default: all
        - name: startDate
          in: query
          description: Start date filter (YYYY-MM-DD)
          schema:
            type: string
            format: date
        - name: endDate
          in: query
          description: End date filter (YYYY-MM-DD)
          schema:
            type: string
            format: date
        - name: vendor
          in: query
          description: Filter by vendor
          schema:
            type: string
        - name: accountNumber
          in: query
          description: Filter by account number
          schema:
            type: string
        - name: category
          in: query
          description: Filter by category
          schema:
            type: string
        - name: limit
          in: query
          description: Maximum number of results
          schema:
            type: integer
            default: 100
        - name: offset
          in: query
          description: Pagination offset
          schema:
            type: integer
            default: 0
      responses:
        '200':
          description: List of transactions
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Transaction'
        '400':
          $ref: '#/components/responses/BadRequest'
        '500':
          $ref: '#/components/responses/InternalError'

  /transactions/{id}:
    get:
      tags:
        - Transactions
      summary: Get a single transaction
      parameters:
        - name: id
          in: path
          required: true
          description: Transaction ID in format `identifier|vendor`
          schema:
            type: string
      responses:
        '200':
          description: Transaction details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Transaction'
        '404':
          description: Transaction not found
        '500':
          $ref: '#/components/responses/InternalError'
    put:
      tags:
        - Transactions
      summary: Update a transaction
      parameters:
        - name: id
          in: path
          required: true
          description: Transaction ID in format `identifier|vendor`
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                price:
                  type: number
                  description: Updated price
                category:
                  type: string
                  description: Updated category
      responses:
        '200':
          description: Transaction updated successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
        '400':
          $ref: '#/components/responses/BadRequest'
        '500':
          $ref: '#/components/responses/InternalError'
    delete:
      tags:
        - Transactions
      summary: Delete a transaction
      parameters:
        - name: id
          in: path
          required: true
          description: Transaction ID in format `identifier|vendor`
          schema:
            type: string
      responses:
        '200':
          description: Transaction deleted successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
        '500':
          $ref: '#/components/responses/InternalError'



  /reports/monthly-summary:
    get:
      tags:
        - Reports
      summary: Get monthly summary
      parameters:
        - name: startDate
          in: query
          schema:
            type: string
            format: date
        - name: endDate
          in: query
          schema:
            type: string
            format: date
        - name: billingCycle
          in: query
          description: Billing cycle (YYYY-MM)
          schema:
            type: string
        - name: vendor
          in: query
          schema:
            type: string
        - name: groupBy
          in: query
          description: Group results by
          schema:
            type: string
            enum: [description, last4digits]
        - name: excludeBankTransactions
          in: query
          description: When true, filters out transactions originating from known bank vendors (e.g. hapoalim, leumi). Useful for isolating card-only expenses.
          schema:
            type: boolean
            default: false
        - name: sortBy
          in: query
          description: Field to sort by
          schema:
            type: string
            enum: [name, count, card_expenses]
            default: card_expenses
        - name: sortOrder
          in: query
          description: Sort direction
          schema:
            type: string
            enum: [asc, desc]
            default: desc
        - name: limit
          in: query
          description: Maximum number of results
          schema:
            type: integer
            default: 50
        - name: offset
          in: query
          description: Pagination offset
          schema:
            type: integer
            default: 0
      responses:
        '200':
          description: Monthly summary data
          content:
            application/json:
              schema:
                type: object
                properties:
                  total:
                    type: integer
                    description: Total number of items matching the filter
                  items:
                    type: array
                    items:
                      type: object
                      properties:
                        bank_income:
                          type: number
                        bank_expenses:
                          type: number
                        card_expenses:
                          type: number
                        net_balance:
                          type: number

  /reports/budget-vs-actual:
    get:
      tags:
        - Reports
      summary: Compare budget vs actual spending
      parameters:
        - name: cycle
          in: query
          description: Billing cycle (YYYY-MM)
          schema:
            type: string
        - name: startDate
          in: query
          schema:
            type: string
            format: date
        - name: endDate
          in: query
          schema:
            type: string
            format: date
      responses:
        '200':
          description: Budget vs actual comparison
          content:
            application/json:
              schema:
                type: array
                items:
                  type: object
                  properties:
                    category:
                      type: string
                    budget_limit:
                      type: number
                    actual_spent:
                      type: number
                    remaining:
                      type: number

  /reports/daily-spending:
    get:
      tags:
        - Reports
      summary: Get daily spending data
      parameters:
        - name: startDate
          in: query
          schema:
            type: string
            format: date
        - name: endDate
          in: query
          schema:
            type: string
            format: date
        - name: cycle
          in: query
          description: Billing cycle (YYYY-MM)
          schema:
            type: string
      responses:
        '200':
          description: Daily spending data
          content:
            application/json:
              schema:
                type: array
                items:
                  type: object
                  properties:
                    date:
                      type: string
                      format: date
                    total:
                      type: number

  /reports/category-expenses:
    get:
      tags:
        - Reports
      summary: Get expenses by category
      parameters:
        - name: startDate
          in: query
          schema:
            type: string
            format: date
        - name: endDate
          in: query
          schema:
            type: string
            format: date
      responses:
        '200':
          description: Category expenses
          content:
            application/json:
              schema:
                type: array
                items:
                  type: object
                  properties:
                    category:
                      type: string
                    total:
                      type: number
                    count:
                      type: integer

  /reports/recurring-payments:
    get:
      tags:
        - Reports
      summary: Get recurring payments (installments and smart subscriptions)
      responses:
        '200':
          description: List of recurring payments and active installments
          content:
            application/json:
              schema:
                type: object
                properties:
                  installments:
                    type: array
                    items:
                      $ref: '#/components/schemas/InstallmentDetail'
                  recurring:
                    type: array
                    items:
                      $ref: '#/components/schemas/RecurringPaymentDetail'

  /budgets:
    get:
      tags:
        - Budgets
      summary: List all budgets
      responses:
        '200':
          description: List of budgets
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Budget'
    post:
      tags:
        - Budgets
      summary: Create or update a budget
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - category
                - budget_limit
              properties:
                category:
                  type: string
                budget_limit:
                  type: number
      responses:
        '200':
          description: Budget created/updated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Budget'

  /budgets/{id}:
    get:
      tags:
        - Budgets
      summary: Get a budget by ID
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
      responses:
        '200':
          description: Budget details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Budget'
    put:
      tags:
        - Budgets
      summary: Update a budget
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                budget_limit:
                  type: number
      responses:
        '200':
          description: Budget updated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Budget'
    delete:
      tags:
        - Budgets
      summary: Delete a budget
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
      responses:
        '200':
          description: Budget deleted
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean

  /reports/total-budget:
    get:
      tags:
        - Reports
      summary: Get total budget limit
      responses:
        '200':
          description: Total budget
          content:
            application/json:
              schema:
                type: object
                properties:
                  budget_limit:
                    type: number
    post:
      tags:
        - Budgets
      summary: Set total budget limit
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - budget_limit
              properties:
                budget_limit:
                  type: number
      responses:
        '200':
          description: Total budget set
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean

  /categories:
    get:
      tags:
        - Categories
      summary: Get all categories
      responses:
        '200':
          description: List of all categories
          content:
            application/json:
              schema:
                type: array
                items:
                  type: string

  /categories/rules:
    get:
      tags:
        - Categories
      summary: Get categorization rules
      responses:
        '200':
          description: List of categorization rules
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/CategorizationRule'
    post:
      tags:
        - Categories
      summary: Create a categorization rule
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - name_pattern
                - target_category
              properties:
                name_pattern:
                  type: string
                  description: Pattern to match in transaction names
                target_category:
                  type: string
                  description: Category to assign
      responses:
        '200':
          description: Rule created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CategorizationRule'

  /categories/mappings:
    get:
      tags:
        - Categories
      summary: Get category mappings
      responses:
        '200':
          description: Category mappings
          content:
            application/json:
              schema:
                type: array
                items:
                  type: object
                  properties:
                    source_category:
                      type: string
                    target_category:
                      type: string
    post:
      tags:
        - Categories
      summary: Create category mapping
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - source_category
                - target_category
              properties:
                source_category:
                  type: string
                target_category:
                  type: string
      responses:
        '200':
          description: Mapping created



  /credentials:
    get:
      tags:
        - Credentials
      summary: List all credentials
      responses:
        '200':
          description: List of credentials
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Credential'
    post:
      tags:
        - Credentials
      summary: Create a credential
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CredentialInput'
      responses:
        '200':
          description: Credential created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Credential'

  /credentials/{id}:
    get:
      tags:
        - Credentials
      summary: Get a credential
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
      responses:
        '200':
          description: Credential details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Credential'
    put:
      tags:
        - Credentials
      summary: Update a credential
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CredentialInput'
      responses:
        '200':
          description: Credential updated
    delete:
      tags:
        - Credentials
      summary: Delete a credential
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
      responses:
        '200':
          description: Credential deleted

  /scrapers/run:
    post:
      tags:
        - Scraping
      summary: Run scraper (sync)
      description: Synchronously run a scraper
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ScrapeRequest'
      responses:
        '200':
          description: Scrape completed
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                  accounts:
                    type: array
                    items:
                      type: object
        '500':
          description: Scrape failed
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                  error:
                    type: string

  /scrapers/run-stream:
    post:
      tags:
        - Scraping
      summary: Run scraper (streaming)
      description: |
        Run scraper with Server-Sent Events for progress updates.
        Returns SSE stream with events: progress, complete, error
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ScrapeRequest'
      responses:
        '200':
          description: SSE stream of scrape progress
          content:
            text/event-stream:
              schema:
                type: string

  /scrapers/sync-all-stream:
    post:
      tags:
        - Scraping
      summary: Sync all credentials (streaming)
      description: |
        Trigger scrape for all active credentials with Server-Sent Events progress updates.
        Returns SSE stream with events: queue, account_start, progress, account_complete, account_error, complete, error
      requestBody:
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/SyncAllRequest'
      responses:
        '200':
          description: SSE stream of sync progress
          content:
            text/event-stream:
              schema:
                type: string

  /scrapers/status:
    get:
      tags:
        - Scraping
      summary: Get current scraping status
      description: Get overall sync health, settings, latest scrape, and history.
      responses:
        '200':
          description: Sync status
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SyncStatusResponse'



  /scrape-events:
    get:
      tags:
        - Scraping
      summary: List scrape and system events
      description: Retrieve history of scraping events and system audit logs (like WhatsApp summaries).
      parameters:
        - name: limit
          in: query
          schema:
            type: integer
            default: 100
      responses:
        '200':
          description: List of events
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/ScrapeEvent'

  /scrape-events/{id}/report:
    get:
      tags:
        - Scraping
      summary: Get detailed scrape report
      parameters:
        - name: id
          in: path
          required: true
          description: Scrape event ID
          schema:
            type: string
      responses:
        '200':
          description: Detailed scrape report
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ScrapeReport'
        '404':
          description: Scrape report not found

  /scrapers/last-transaction-date:
    get:
      tags:
        - Scraping
      summary: Get last transaction date for a vendor
      parameters:
        - name: vendor
          in: query
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Most recent transaction date
          content:
            application/json:
              schema:
                type: object
                properties:
                  lastDate:
                    type: string
                    format: date-time

  /chat/message:
    post:
      tags:
        - AI Chat
      summary: Chat with financial AI assistant
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/AIChatRequest'
      responses:
        '200':
          description: AI response
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AIChatResponse'

  /chat/stream:
    post:
      tags:
        - AI Chat
      summary: Chat with financial AI assistant (streaming)
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/AIChatRequest'
      responses:
        '200':
          description: SSE stream of AI response
          content:
            text/event-stream:
              schema:
                type: string

  /scrapers/stop:
    post:
      tags:
        - Scraping
      summary: Stop all running scrapers
      responses:
        '200':
          description: Scrapers stopped
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  message:
                    type: string

  /settings:
    get:
      tags:
        - Settings
      summary: Get all settings
      responses:
        '200':
          description: Application settings
          content:
            application/json:
              schema:
                type: object
                additionalProperties: true
    put:
      tags:
        - Settings
      summary: Update settings
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              additionalProperties: true
      responses:
        '200':
          description: Settings updated


  /whatsapp/status:
    get:
      tags:
        - WhatsApp
      summary: Get WhatsApp connection status
      responses:
        '200':
          description: WhatsApp status and QR code
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    enum: [DISCONNECTED, INITIALIZING, QR_READY, AUTHENTICATED, READY]
                  qr:
                    type: string
                    nullable: true
                    description: QR code string to be rendered
                  timestamp:
                    type: string
                    format: date-time
    post:
      tags:
        - WhatsApp
      summary: Control WhatsApp client
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - action
              properties:
                action:
                  type: string
                  enum: [connect, restart, disconnect]
                  description: 'connect: Start client and generate QR code; restart: Restart client; disconnect: disconnect session'
      responses:
        '200':
          description: Action performed
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string

  /whatsapp-test:
    post:
      tags:
        - WhatsApp
      summary: Run WhatsApp integration test
      description: Generates a daily summary and attempts to send it via WhatsApp.
      responses:
        '200':
          description: Test completed successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  message:
                    type: string
                  results:
                    type: array
                    items:
                      type: object
        '400':
          description: Invalid configuration
        '500':
          description: Test failed
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  error:
                    type: string
                  message:
                    type: string
                    nullable: true


  /reports/available-months:
    get:
      tags:
        - Reports
      summary: Get available months
      description: List of months with transaction data
      responses:
        '200':
          description: Available months
          content:
            application/json:
              schema:
                type: array
                items:
                  type: string

  /ping:
    get:
      tags:
        - Settings
      summary: Health check
      responses:
        '200':
          description: Service is healthy
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    example: ok

  /reports/month-by-categories:
    get:
      tags:
        - Reports
      summary: Get monthly category breakdown
      parameters:
        - name: startDate
          in: query
          schema:
            type: string
            format: date
        - name: endDate
          in: query
          schema:
            type: string
            format: date
        - name: billingCycle
          in: query
          schema:
            type: string
      responses:
        '200':
          description: Monthly category breakdown
          content:
            application/json:
              schema:
                type: array
                items:
                  type: object
                  properties:
                    category:
                      type: string
                    amount:
                      type: number
                    count:
                      type: integer

  /reports/box-panel:
    get:
      tags:
        - Reports
      summary: Get box panel summary data
      parameters:
        - name: startDate
          in: query
          schema:
            type: string
            format: date
        - name: endDate
          in: query
          schema:
            type: string
            format: date
        - name: billingCycle
          in: query
          schema:
            type: string
      responses:
        '200':
          description: Box panel data
          content:
            application/json:
              schema:
                type: object
                properties:
                  total_income:
                    type: number
                  total_expenses:
                    type: number
                  net_savings:
                    type: number
                  savings_rate:
                    type: number



  /categories/uncategorized:
    get:
      tags:
        - Categories
      summary: Get uncategorized descriptions
      responses:
        '200':
          description: List of descriptions
          content:
            application/json:
              schema:
                type: array
                items:
                  type: object
                  properties:
                    description:
                      type: string
                    count:
                      type: integer
                    totalAmount:
                      type: number

  /categories/apply-rules:
    post:
      tags:
        - Categories
      summary: Apply categorization rules
      responses:
        '200':
          description: Rules applied
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  rulesApplied:
                    type: integer
                  transactionsUpdated:
                    type: integer

  /categories/update-by-description:
    post:
      tags:
        - Categories
      summary: Update category for all transactions with a specific description
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - description
                - newCategory
              properties:
                description:
                  type: string
                newCategory:
                  type: string
                createRule:
                  type: boolean
      responses:
        '200':
          description: Updated successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean

  /cards/ownerships:
    get:
      tags:
        - Credentials
      summary: Get card ownership mappings
      responses:
        '200':
          description: List of card ownerships
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/CardOwnership'

  /cards/ownerships/{id}:
    patch:
      tags:
        - Credentials
      summary: Update card ownership
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
      requestBody:
        content:
          application/json:
            schema:
              type: object
              properties:
                linked_bank_account_id:
                  type: integer
                custom_bank_account_number:
                  type: string
                custom_bank_account_nickname:
                  type: string
      responses:
        '200':
          description: Updated successfully

  /cards:
    get:
      tags:
        - Credentials
      summary: Get credit card vendors and details (excludes bank accounts)
      responses:
        '200':
          description: List of cards
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/CardVendor'
    post:
      tags:
        - Credentials
      summary: Create or update card vendor
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CardVendor'
      responses:
        '200':
          description: Created/Updated
    delete:
      tags:
        - Credentials
      summary: Delete card vendor
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - last4_digits
              properties:
                last4_digits:
                  type: string
      responses:
        '200':
          description: Deleted

  /credentials/truncate/{id}:
    delete:
      tags:
        - Credentials
      summary: Truncate credential transactions
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
      responses:
        '200':
          description: Data truncated

  /chat/history:
    get:
      tags:
        - Reports
      summary: Get chat history (sessions)
      responses:
        '200':
          description: List of sessions
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/ChatSession'
    delete:
      tags:
        - Reports
      summary: Delete chat session
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - id
              properties:
                id:
                  type: string
      responses:
        '200':
          description: Deleted

  /chat/messages:
    get:
      tags:
        - Reports
      summary: Get chat messages
      parameters:
        - name: sessionId
          in: query
          required: true
          schema:
            type: string
      responses:
        '200':
          description: List of messages
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/ChatMessage'

  /maintenance/database/export:
    get:
      tags:
        - Settings
      summary: Export database
      responses:
        '200':
          description: Database backup JSON
          content:
            application/json:
              schema:
                type: object

  /maintenance/database/import:
    post:
      tags:
        - Settings
      summary: Import database
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                data:
                  type: object
                mode:
                  type: string
                  enum: [replace, merge]
      responses:
        '200':
          description: Import result
  /mcp:
    get:
      tags:
        - Settings
      summary: Establish MCP SSE connection
      description: |
        Endpoint for Server-Sent Events (SSE) connection in Model Context Protocol (MCP).
        This keeps a long-running connection open to relay messages to the MCP server.
      responses:
        '200':
          description: SSE stream
          content:
            text/event-stream:
              schema:
                type: string
                format: binary
    post:
      tags:
        - Settings
      summary: Send message to MCP server
      description: |
        Relays a JSON-RPC message to an active MCP session identified by the sessionId.
      parameters:
        - name: sessionId
          in: query
          required: true
          description: Unique session ID established via the GET /mcp request.
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
      responses:
        '202':
          description: Accepted
        '400':
          $ref: '#/components/responses/BadRequest'
        '404':
          description: Session not found

components:
  schemas:
    Transaction:
      type: object
      properties:
        identifier:
          type: string
          description: Unique transaction identifier
        vendor:
          type: string
          description: Source vendor (bank or credit card company)
        date:
          type: string
          format: date
          description: Transaction date
        name:
          type: string
          description: Transaction description
        price:
          type: number
          description: Transaction amount
        category:
          type: string
          description: Transaction category
        type:
          type: string
          description: Transaction type (credit/debit)
        processed_date:
          type: string
          format: date
          description: Processing date (for billing cycle)
        original_amount:
          type: number
          description: Original amount (for foreign transactions)
        original_currency:
          type: string
          description: Original currency code
        charged_currency:
          type: string
          description: Charged currency code
        memo:
          type: string
          description: Additional notes
        status:
          type: string
          description: Transaction status
        installments_number:
          type: integer
          description: Current installment number
        installments_total:
          type: integer
          description: Total number of installments
        account_number:
          type: string
          description: Card/account last 4 digits
        category_source:
          type: string
          description: How the category was assigned (scraper/rule/cache)
        rule_matched:
          type: string
          description: Pattern that matched for rule-based categorization
        transaction_type:
          type: string
          enum: [bank, credit_card]
          description: Whether this is a bank or credit card transaction

    Budget:
      type: object
      properties:
        id:
          type: integer
        category:
          type: string
          description: Category name
        budget_limit:
          type: number
          description: Monthly budget limit
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time

    CategorizationRule:
      type: object
      properties:
        id:
          type: integer
        name_pattern:
          type: string
          description: Pattern to match in transaction names
        target_category:
          type: string
          description: Category to assign when matched
        is_active:
          type: boolean

    Credential:
      type: object
      properties:
        id:
          type: integer
        vendor:
          type: string
          description: Bank or credit card vendor
        nickname:
          type: string
          description: Friendly name for this credential
        is_active:
          type: boolean
        last_synced_at:
          type: string
          format: date-time
        created_at:
          type: string
          format: date-time

    CredentialInput:
      type: object
      required:
        - vendor
      properties:
        vendor:
          type: string
          description: Bank or credit card vendor ID
        username:
          type: string
        password:
          type: string
        id_number:
          type: string
          description: ID number (for Israeli banks)
        card6_digits:
          type: string
          description: First 6 digits of card (for Isracard/Amex)
        nickname:
          type: string
        is_active:
          type: boolean
          default: true

    ScrapeRequest:
      type: object
      required:
        - options
        - credentials
        - credentialId
      properties:
        options:
          type: object
          required:
            - companyId
            - startDate
          properties:
            companyId:
              type: string
              description: Vendor ID (e.g., visaCal, hapoalim)
            startDate:
              type: string
              format: date
              description: Start date for scraping
            showBrowser:
              type: boolean
              description: Show browser window (for debugging/2FA)
        credentials:
          type: object
          description: Vendor-specific credentials
        credentialId:
          type: integer
          description: Database credential ID

    ScrapeEvent:
      type: object
      properties:
        id:
          type: integer
        triggered_by:
          type: string
        vendor:
          type: string
        status:
          type: string
        message:
          type: string
        created_at:
          type: string
          format: date-time
        duration_seconds:
          type: number
        report_json:
          $ref: '#/components/schemas/ScrapeReport'

    ScrapeReport:
      type: object
      properties:
        processedTransactions:
          type: array
          items:
            type: object
            properties:
              date:
                type: string
                format: date
              description:
                type: string
              amount:
                type: number
              currency:
                type: string
              category:
                type: string
              source:
                type: string
              rule:
                type: string
              cardLast4:
                type: string
              isUpdate:
                type: boolean
              isDuplicate:
                type: boolean
              isBank:
                type: boolean
              oldCategory:
                type: string
              installmentsNumber:
                type: integer
              installmentsTotal:
                type: integer
              totalAmount:
                type: number
        savedTransactions:
          type: integer
        duration_seconds:
          type: number
        body:
          type: string
          description: Full message body for notification events
        to:
          type: string
          description: Recipient for notification events
        error:
          type: string
          description: Error details if event failed

    SyncAllRequest:
      type: object
      properties:
        daysBack:
          type: integer
          default: 30

    SyncStatusResponse:
      type: object
      properties:
        syncHealth:
          type: string
          enum: [healthy, stale, outdated, error, syncing, no_accounts, never_synced, unknown]
        settings:
          type: object
          properties:
            enabled:
              type: boolean
            syncHour:
              type: integer
            daysBack:
              type: integer
        activeAccounts:
          type: integer
        latestScrape:
          $ref: '#/components/schemas/ScrapeEvent'
        history:
          type: array
          items:
            $ref: '#/components/schemas/ScrapeEvent'
        accountSyncStatus:
          type: array
          items:
            type: object
            properties:
              id:
                type: integer
              nickname:
                type: string
              vendor:
                type: string
              last_synced_at:
                type: string
                format: date-time

    InstallmentDetail:
      type: object
      properties:
        name:
          type: string
        price:
          type: number
        original_amount:
          type: number
        original_currency:
          type: string
        category:
          type: string
        vendor:
          type: string
        account_number:
          type: string
        current_installment:
          type: integer
        total_installments:
          type: integer
        last_charge_date:
          type: string
          format: date
        next_payment_date:
          type: string
          format: date
        status:
          type: string
          enum: [active, completed]

    RecurringPaymentDetail:
      type: object
      properties:
        name:
          type: string
        monthly_amount:
          type: number
        price:
          type: number
        category:
          type: string
        vendor:
          type: string
        account_number:
          type: string
        month_count:
          type: integer
        last_charge_date:
          type: string
          format: date
        frequency:
          type: string
          enum: [monthly, bi-monthly]
        months:
          type: array
          items:
            type: string
        next_payment_date:
          type: string
          format: date

    AIChatRequest:
      type: object
      required:
        - message
      properties:
        message:
          type: string
        context:
          type: object
        sessionId:
          type: string

    AIChatResponse:
      type: object
      properties:
        response:
          type: string
        success:
          type: boolean
        model:
          type: string

    CardOwnership:
      type: object
      properties:
        id:
          type: integer
        vendor:
          type: string
        account_number:
          type: string
        linked_bank_account_id:
          type: integer
        custom_bank_account_number:
          type: string
        custom_bank_account_nickname:
          type: string

    CardVendor:
      type: object
      properties:
        last4_digits:
          type: string
        card_vendor:
          type: string
        card_nickname:
          type: string
        transaction_count:
          type: integer

    ChatSession:
      type: object
      properties:
        id:
          type: string
        title:
          type: string
        created_at:
          type: string
          format: date-time
        last_message_at:
          type: string
          format: date-time

    ChatMessage:
      type: object
      properties:
        id:
          type: integer
        role:
          type: string
          enum: [user, assistant]
        content:
          type: string
        timestamp:
          type: string
          format: date-time

    WhatsAppStatus:
      type: object
      properties:
        status:
          type: string
          enum: [DISCONNECTED, INITIALIZING, QR_READY, AUTHENTICATED, READY]
        qr:
          type: string
          nullable: true
          description: QR code string if status is QR_READY

    WhatsAppActionRequest:
      type: object
      required:
        - action
      properties:
        action:
          type: string
          enum: [restart, disconnect]

  responses:
    BadRequest:
      description: Bad request
      content:
        application/json:
          schema:
            type: object
            properties:
              error:
                type: string
    InternalError:
      description: Internal server error
      content:
        application/json:
          schema:
            type: object
            properties:
              error:
                type: string
              details:
                type: string
