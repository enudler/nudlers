openapi: 3.0.3
info:
  title: Nudlers Finance API
  description: |
    API for managing personal finance transactions, budgets, and bank/credit card scraping.

    ## Transaction Types
    Transactions can be of two types:
    - `credit_card` - Credit card transactions from vendors like visaCal, max, isracard, amex
    - `bank` - Bank account transactions from vendors like hapoalim, leumi, mizrahi, discount

    Use the `transactionType` query parameter to filter transactions by type.

    ## RESTful Design
    This API follows RESTful conventions:
    - Collection endpoints use GET (list) and POST (create)
    - Resource endpoints use GET (read), PUT/PATCH (update), and DELETE (remove)
    - Path parameters identify specific resources
  version: 1.1.0
  contact:
    name: Nudlers
  license:
    name: MIT

servers:
  - url: /api
    description: API Server

tags:
  - name: Transactions
    description: Transaction management (credit cards and bank accounts)
  - name: Categories
    description: Category management and categorization
  - name: Budgets
    description: Budget management
  - name: Scraping
    description: Bank and credit card scraping
  - name: Credentials
    description: Account credentials management
  - name: Cards
    description: Card vendor mapping management
  - name: Settings
    description: Application settings
  - name: Reports
    description: Financial reports and summaries
  - name: Chat
    description: AI chat assistant
  - name: WhatsApp
    description: WhatsApp notification service
  - name: Debug
    description: Debug and diagnostic tools
  - name: Maintenance
    description: Database maintenance operations

paths:
  /transactions:
    get:
      tags:
        - Transactions
      summary: List transactions
      description: |
        Retrieve transactions with optional filtering by type, date range, vendor, etc.
        Default returns all transactions (both bank and credit card).
      parameters:
        - name: transactionType
          in: query
          description: Filter by transaction type
          schema:
            type: string
            enum: [all, bank, credit_card]
            default: all
        - name: startDate
          in: query
          description: Start date filter (YYYY-MM-DD)
          schema:
            type: string
            format: date
        - name: endDate
          in: query
          description: End date filter (YYYY-MM-DD)
          schema:
            type: string
            format: date
        - name: billingCycle
          in: query
          description: Billing cycle (YYYY-MM)
          schema:
            type: string
        - name: vendor
          in: query
          description: Filter by vendor
          schema:
            type: string
        - name: accountNumber
          in: query
          description: Filter by account number
          schema:
            type: string
        - name: category
          in: query
          description: Filter by category
          schema:
            type: string
        - name: description
          in: query
          description: Filter by transaction description (exact match)
          schema:
            type: string
        - name: last4digits
          in: query
          description: Filter by last 4 digits of card
          schema:
            type: string
        - name: q
          in: query
          description: Search query (searches name, vendor, category, identifier)
          schema:
            type: string
        - name: uncategorizedOnly
          in: query
          description: Only return uncategorized transactions
          schema:
            type: boolean
            default: false
        - name: limit
          in: query
          description: Maximum number of results
          schema:
            type: integer
            default: 100
        - name: offset
          in: query
          description: Pagination offset
          schema:
            type: integer
            default: 0
      responses:
        '200':
          description: List of transactions
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Transaction'
        '400':
          $ref: '#/components/responses/BadRequest'
        '500':
          $ref: '#/components/responses/InternalError'
    delete:
      tags:
        - Transactions
      summary: Delete all transactions
      description: Delete all transactions (requires confirmation)
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - confirm
              properties:
                confirm:
                  type: boolean
                  description: Must be true to confirm deletion
      responses:
        '200':
          description: Transactions deleted
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  deleted:
                    type: integer
        '400':
          $ref: '#/components/responses/BadRequest'
        '500':
          $ref: '#/components/responses/InternalError'

  /transactions/{id}:
    get:
      tags:
        - Transactions
      summary: Get a single transaction
      parameters:
        - name: id
          in: path
          required: true
          description: Transaction ID in format `identifier|vendor`
          schema:
            type: string
      responses:
        '200':
          description: Transaction details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Transaction'
        '404':
          description: Transaction not found
        '500':
          $ref: '#/components/responses/InternalError'
    put:
      tags:
        - Transactions
      summary: Update a transaction
      parameters:
        - name: id
          in: path
          required: true
          description: Transaction ID in format `identifier|vendor`
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                price:
                  type: number
                  description: Updated price
                category:
                  type: string
                  description: Updated category
      responses:
        '200':
          description: Transaction updated successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
        '400':
          $ref: '#/components/responses/BadRequest'
        '500':
          $ref: '#/components/responses/InternalError'
    delete:
      tags:
        - Transactions
      summary: Delete a transaction
      parameters:
        - name: id
          in: path
          required: true
          description: Transaction ID in format `identifier|vendor`
          schema:
            type: string
      responses:
        '200':
          description: Transaction deleted successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
        '500':
          $ref: '#/components/responses/InternalError'

  /accounts:
    get:
      tags:
        - Credentials
      summary: List all accounts
      description: Returns a list of all bank and credit card accounts with their latest balances.
      responses:
        '200':
          description: A list of accounts
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Account'

  /categories:
    get:
      tags:
        - Categories
      summary: Get all categories
      responses:
        '200':
          description: List of all categories
          content:
            application/json:
              schema:
                type: array
                items:
                  type: string

  /categories/{name}:
    patch:
      tags:
        - Categories
      summary: Rename a category
      parameters:
        - name: name
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - newName
              properties:
                newName:
                  type: string
      responses:
        '200':
          description: Category renamed
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  transactionsUpdated:
                    type: integer
                  rulesUpdated:
                    type: integer
                  budgetsUpdated:
                    type: integer
    delete:
      tags:
        - Categories
      summary: Delete a category
      description: Uncategorizes all transactions with this category
      parameters:
        - name: name
          in: path
          required: true
          schema:
            type: string
      requestBody:
        content:
          application/json:
            schema:
              type: object
              properties:
                deleteRules:
                  type: boolean
                  default: true
                deleteBudget:
                  type: boolean
                  default: true
      responses:
        '200':
          description: Category deleted
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  transactionsUncategorized:
                    type: integer

  /categories/uncategorized:
    get:
      tags:
        - Categories
      summary: Get uncategorized descriptions
      responses:
        '200':
          description: List of descriptions
          content:
            application/json:
              schema:
                type: array
                items:
                  type: object
                  properties:
                    description:
                      type: string
                    count:
                      type: integer
                    totalAmount:
                      type: number

  /categories/rules:
    get:
      tags:
        - Categories
      summary: Get categorization rules
      responses:
        '200':
          description: List of categorization rules
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/CategorizationRule'
    post:
      tags:
        - Categories
      summary: Create a categorization rule
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - name_pattern
                - target_category
              properties:
                name_pattern:
                  type: string
                  description: Pattern to match in transaction names
                target_category:
                  type: string
                  description: Category to assign
      responses:
        '200':
          description: Rule created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CategorizationRule'

  /categories/rules/{id}:
    get:
      tags:
        - Categories
      summary: Get a categorization rule
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
      responses:
        '200':
          description: Rule details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CategorizationRule'
        '404':
          description: Rule not found
    put:
      tags:
        - Categories
      summary: Update a categorization rule
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - name_pattern
                - target_category
              properties:
                name_pattern:
                  type: string
                target_category:
                  type: string
                is_active:
                  type: boolean
      responses:
        '200':
          description: Rule updated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CategorizationRule'
        '404':
          description: Rule not found
    delete:
      tags:
        - Categories
      summary: Delete a categorization rule
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
      responses:
        '200':
          description: Rule deleted
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
        '404':
          description: Rule not found

  /categories/mappings:
    get:
      tags:
        - Categories
      summary: Get category mappings
      responses:
        '200':
          description: Category mappings
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/CategoryMapping'
    post:
      tags:
        - Categories
      summary: Create category mapping
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - source_category
                - target_category
              properties:
                source_category:
                  type: string
                target_category:
                  type: string
      responses:
        '200':
          description: Mapping created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CategoryMapping'

  /categories/mappings/{id}:
    get:
      tags:
        - Categories
      summary: Get a category mapping
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
      responses:
        '200':
          description: Mapping details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CategoryMapping'
        '404':
          description: Mapping not found
    delete:
      tags:
        - Categories
      summary: Delete a category mapping
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
      responses:
        '200':
          description: Mapping deleted
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
        '404':
          description: Mapping not found

  /categories/apply-rules:
    post:
      tags:
        - Categories
      summary: Apply categorization rules
      description: Apply all active categorization rules to existing transactions
      responses:
        '200':
          description: Rules applied
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  rulesApplied:
                    type: integer
                  transactionsUpdated:
                    type: integer

  /categories/merge:
    post:
      tags:
        - Categories
      summary: Merge categories
      description: Merge multiple source categories into a single target category
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - sourceCategories
                - newCategoryName
              properties:
                sourceCategories:
                  type: array
                  items:
                    type: string
                  minItems: 2
                newCategoryName:
                  type: string
      responses:
        '200':
          description: Categories merged
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  updatedRows:
                    type: integer

  /categories/update-by-description:
    post:
      tags:
        - Categories
      summary: Update category for all transactions with a specific description
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - description
                - newCategory
              properties:
                description:
                  type: string
                newCategory:
                  type: string
                createRule:
                  type: boolean
                  default: true
      responses:
        '200':
          description: Updated successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  transactionsUpdated:
                    type: integer
                  ruleCreated:
                    type: boolean
                  ruleUpdated:
                    type: boolean

  /budgets:
    get:
      tags:
        - Budgets
      summary: List all budgets
      responses:
        '200':
          description: List of budgets
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Budget'
    post:
      tags:
        - Budgets
      summary: Create or update a budget
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - category
                - budget_limit
              properties:
                category:
                  type: string
                budget_limit:
                  type: number
      responses:
        '201':
          description: Budget created/updated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Budget'

  /budgets/{id}:
    put:
      tags:
        - Budgets
      summary: Update a budget
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - budget_limit
              properties:
                budget_limit:
                  type: number
      responses:
        '200':
          description: Budget updated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Budget'
        '404':
          description: Budget not found
    delete:
      tags:
        - Budgets
      summary: Delete a budget
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
      responses:
        '200':
          description: Budget deleted
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
        '404':
          description: Budget not found

  /cards:
    get:
      tags:
        - Cards
      summary: Get credit card vendors and details
      description: Returns all unique card endings from transactions with their vendor mappings
      responses:
        '200':
          description: List of cards
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/CardVendor'
    post:
      tags:
        - Cards
      summary: Create or update card vendor mapping
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - last4_digits
                - card_vendor
              properties:
                last4_digits:
                  type: string
                card_vendor:
                  type: string
                card_nickname:
                  type: string
      responses:
        '201':
          description: Created/Updated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CardVendor'

  /cards/{last4_digits}:
    get:
      tags:
        - Cards
      summary: Get a card vendor mapping
      parameters:
        - name: last4_digits
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Card vendor details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CardVendor'
        '404':
          description: Card vendor not found
    put:
      tags:
        - Cards
      summary: Update a card vendor mapping
      parameters:
        - name: last4_digits
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - card_vendor
              properties:
                card_vendor:
                  type: string
                card_nickname:
                  type: string
      responses:
        '200':
          description: Card vendor updated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CardVendor'
        '404':
          description: Card vendor not found
    delete:
      tags:
        - Cards
      summary: Delete a card vendor mapping
      parameters:
        - name: last4_digits
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Deleted
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
        '404':
          description: Card vendor not found

  /cards/ownerships:
    get:
      tags:
        - Cards
      summary: Get card ownership mappings
      responses:
        '200':
          description: List of card ownerships
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/CardOwnership'

  /cards/ownerships/{id}:
    patch:
      tags:
        - Cards
      summary: Update card ownership
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
      requestBody:
        content:
          application/json:
            schema:
              type: object
              properties:
                linked_bank_account_id:
                  type: integer
                custom_bank_account_number:
                  type: string
                custom_bank_account_nickname:
                  type: string
      responses:
        '200':
          description: Updated successfully

  /credentials:
    get:
      tags:
        - Credentials
      summary: List all credentials
      parameters:
        - name: vendor
          in: query
          description: Filter by vendor
          schema:
            type: string
      responses:
        '200':
          description: List of credentials
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Credential'
    post:
      tags:
        - Credentials
      summary: Create a credential
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CredentialInput'
      responses:
        '200':
          description: Credential created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Credential'

  /credentials/{id}:
    get:
      tags:
        - Credentials
      summary: Get a credential (with decrypted passwords for scraping)
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
      responses:
        '200':
          description: Credential details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Credential'
    put:
      tags:
        - Credentials
      summary: Update a credential
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CredentialInput'
      responses:
        '200':
          description: Credential updated
    patch:
      tags:
        - Credentials
      summary: Toggle credential active status
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - is_active
              properties:
                is_active:
                  type: boolean
      responses:
        '200':
          description: Status updated
    delete:
      tags:
        - Credentials
      summary: Delete a credential
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
      responses:
        '200':
          description: Credential deleted

  /credentials/truncate/{id}:
    delete:
      tags:
        - Credentials
      summary: Truncate credential transactions
      description: Delete all transactions for a specific account
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
      responses:
        '200':
          description: Data truncated

  /scrapers/run:
    post:
      tags:
        - Scraping
      summary: Run scraper (sync)
      description: Synchronously run a scraper
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ScrapeRequest'
      responses:
        '200':
          description: Scrape completed
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                  accounts:
                    type: array
                    items:
                      type: object
                  duration:
                    type: string
                  durationSeconds:
                    type: number
        '409':
          description: Scraper already running
        '500':
          description: Scrape failed

  /scrapers/run-stream:
    post:
      tags:
        - Scraping
      summary: Run scraper (streaming)
      description: Run scraper with Server-Sent Events for progress updates
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ScrapeRequest'
      responses:
        '200':
          description: SSE stream of scrape progress
          content:
            text/event-stream:
              schema:
                type: string

  /scrapers/sync-all:
    post:
      tags:
        - Scraping
      summary: Get accounts ready for syncing
      description: Get list of all active accounts ready for syncing
      responses:
        '200':
          description: List of accounts to sync
          content:
            application/json:
              schema:
                type: array
                items:
                  type: object

  /scrapers/sync-all-stream:
    post:
      tags:
        - Scraping
      summary: Sync all credentials (streaming)
      description: Trigger scrape for all active credentials with SSE progress updates
      requestBody:
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/SyncAllRequest'
      responses:
        '200':
          description: SSE stream of sync progress
          content:
            text/event-stream:
              schema:
                type: string

  /scrapers/stop:
    post:
      tags:
        - Scraping
      summary: Stop all running scrapers
      responses:
        '200':
          description: Scrapers stopped
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  message:
                    type: string

  /scrapers/status:
    get:
      tags:
        - Scraping
      summary: Get current scraping status
      description: Get overall sync health, settings, latest scrape, and optional history/account details
      parameters:
        - name: minimal
          in: query
          description: If true, returns a summary without history or full account list
          schema:
            type: boolean
            default: false
      responses:
        '200':
          description: Sync status
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SyncStatusResponse'

  /scrapers/vendors:
    get:
      tags:
        - Scraping
      summary: List vendors
      description: List all vendors from transactions with their type (bank/card)
      responses:
        '200':
          description: List of vendors
          content:
            application/json:
              schema:
                type: array
                items:
                  type: object
                  properties:
                    vendor:
                      type: string
                    type:
                      type: string
                      enum: [bank, card]

  /scrapers/last-transaction-date:
    get:
      tags:
        - Scraping
      summary: Get last transaction date for a vendor
      parameters:
        - name: vendor
          in: query
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Most recent transaction date
          content:
            application/json:
              schema:
                type: object
                properties:
                  lastDate:
                    type: string
                    format: date-time

  /scrape-events:
    get:
      tags:
        - Scraping
      summary: List scrape and system events
      description: Retrieve history of scraping events and system audit logs
      parameters:
        - name: limit
          in: query
          schema:
            type: integer
            default: 100
      responses:
        '200':
          description: List of events
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/ScrapeEvent'

  /scrape-events/{id}/report:
    get:
      tags:
        - Scraping
      summary: Get detailed scrape report
      parameters:
        - name: id
          in: path
          required: true
          description: Scrape event ID
          schema:
            type: string
      responses:
        '200':
          description: Detailed scrape report
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ScrapeReport'
        '404':
          description: Scrape report not found

  /reports/available-months:
    get:
      tags:
        - Reports
      summary: Get available months
      description: List of months with transaction data
      responses:
        '200':
          description: Available months
          content:
            application/json:
              schema:
                type: array
                items:
                  type: string

  /reports/box-panel:
    get:
      tags:
        - Reports
      summary: Get box panel summary data
      parameters:
        - name: startDate
          in: query
          schema:
            type: string
            format: date
        - name: endDate
          in: query
          schema:
            type: string
            format: date
        - name: billingCycle
          in: query
          schema:
            type: string
      responses:
        '200':
          description: Box panel data
          content:
            application/json:
              schema:
                type: object
                properties:
                  total_income:
                    type: number
                  total_expenses:
                    type: number
                  net_savings:
                    type: number
                  savings_rate:
                    type: number

  /reports/budget-vs-actual:
    get:
      tags:
        - Reports
      summary: Compare budget vs actual spending
      parameters:
        - name: cycle
          in: query
          description: Billing cycle (YYYY-MM)
          schema:
            type: string
        - name: startDate
          in: query
          schema:
            type: string
            format: date
        - name: endDate
          in: query
          schema:
            type: string
            format: date
      responses:
        '200':
          description: Budget vs actual comparison
          content:
            application/json:
              schema:
                type: array
                items:
                  type: object
                  properties:
                    category:
                      type: string
                    budget_limit:
                      type: number
                    actual_spent:
                      type: number
                    remaining:
                      type: number

  /reports/category-expenses:
    get:
      tags:
        - Reports
      summary: Get expenses by category
      parameters:
        - name: startDate
          in: query
          schema:
            type: string
            format: date
        - name: endDate
          in: query
          schema:
            type: string
            format: date
        - name: category
          in: query
          schema:
            type: string
        - name: billingCycle
          in: query
          schema:
            type: string
      responses:
        '200':
          description: Category expenses
          content:
            application/json:
              schema:
                type: array
                items:
                  type: object
                  properties:
                    category:
                      type: string
                    total:
                      type: number
                    count:
                      type: integer

  /reports/daily-spending:
    get:
      tags:
        - Reports
      summary: Get daily spending data
      parameters:
        - name: startDate
          in: query
          schema:
            type: string
            format: date
        - name: endDate
          in: query
          schema:
            type: string
            format: date
        - name: cycle
          in: query
          description: Billing cycle (YYYY-MM)
          schema:
            type: string
      responses:
        '200':
          description: Daily spending data
          content:
            application/json:
              schema:
                type: array
                items:
                  type: object
                  properties:
                    date:
                      type: string
                      format: date
                    total:
                      type: number

  /reports/month-by-categories:
    get:
      tags:
        - Reports
      summary: Get monthly category breakdown
      parameters:
        - name: startDate
          in: query
          schema:
            type: string
            format: date
        - name: endDate
          in: query
          schema:
            type: string
            format: date
        - name: billingCycle
          in: query
          schema:
            type: string
      responses:
        '200':
          description: Monthly category breakdown
          content:
            application/json:
              schema:
                type: array
                items:
                  type: object
                  properties:
                    category:
                      type: string
                    amount:
                      type: number
                    count:
                      type: integer

  /reports/monthly-summary:
    get:
      tags:
        - Reports
      summary: Get monthly summary
      parameters:
        - name: startDate
          in: query
          schema:
            type: string
            format: date
        - name: endDate
          in: query
          schema:
            type: string
            format: date
        - name: billingCycle
          in: query
          description: Billing cycle (YYYY-MM)
          schema:
            type: string
        - name: vendor
          in: query
          schema:
            type: string
        - name: groupBy
          in: query
          description: Group results by
          schema:
            type: string
            enum: [description, last4digits]
        - name: excludeBankTransactions
          in: query
          schema:
            type: boolean
            default: false
        - name: sortBy
          in: query
          schema:
            type: string
            enum: [name, count, card_expenses]
            default: card_expenses
        - name: sortOrder
          in: query
          schema:
            type: string
            enum: [asc, desc]
            default: desc
        - name: limit
          in: query
          schema:
            type: integer
            default: 50
        - name: offset
          in: query
          schema:
            type: integer
            default: 0
      responses:
        '200':
          description: Monthly summary data
          content:
            application/json:
              schema:
                type: object
                properties:
                  total:
                    type: integer
                  items:
                    type: array
                    items:
                      type: object

  /reports/recurring-payments:
    get:
      tags:
        - Reports
      summary: Get recurring payments
      description: Returns paginated lists of installment transactions and detected recurring payments
      parameters:
        - name: type
          in: query
          schema:
            type: string
            enum: [all, installments, recurring]
            default: all
        - name: status
          in: query
          schema:
            type: string
            enum: [all, active, completed]
            default: all
        - name: frequency
          in: query
          schema:
            type: string
            enum: [all, monthly, bi-monthly]
            default: all
        - name: limit
          in: query
          schema:
            type: integer
            default: 50
            maximum: 500
        - name: offset
          in: query
          schema:
            type: integer
            default: 0
        - name: sortBy
          in: query
          schema:
            type: string
            enum: [status, amount, next_payment_date, name, frequency, month_count, last_charge_date]
        - name: sortOrder
          in: query
          schema:
            type: string
            enum: [asc, desc]
            default: desc
      responses:
        '200':
          description: List of recurring payments
          content:
            application/json:
              schema:
                type: object
                properties:
                  installments:
                    type: array
                    items:
                      $ref: '#/components/schemas/InstallmentDetail'
                  recurring:
                    type: array
                    items:
                      $ref: '#/components/schemas/RecurringPaymentDetail'
                  pagination:
                    type: object
                    properties:
                      limit:
                        type: integer
                      offset:
                        type: integer
                      totalInstallments:
                        type: integer
                      totalRecurring:
                        type: integer
                      total:
                        type: integer

  /reports/non-recurring-exclusions:
    get:
      tags:
        - Reports
      summary: List non-recurring exclusions
      responses:
        '200':
          description: List of exclusions
          content:
            application/json:
              schema:
                type: object
                properties:
                  exclusions:
                    type: array
                    items:
                      $ref: '#/components/schemas/NonRecurringExclusion'
                  total:
                    type: integer
    post:
      tags:
        - Reports
      summary: Mark a transaction as non-recurring
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - name
              properties:
                name:
                  type: string
                account_number:
                  type: string
      responses:
        '201':
          description: Exclusion created
        '200':
          description: Already existed

  /reports/non-recurring-exclusions/{id}:
    get:
      tags:
        - Reports
      summary: Get a non-recurring exclusion
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
      responses:
        '200':
          description: Exclusion details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/NonRecurringExclusion'
        '404':
          description: Exclusion not found
    delete:
      tags:
        - Reports
      summary: Remove a non-recurring exclusion
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
      responses:
        '200':
          description: Exclusion removed
        '404':
          description: Exclusion not found

  /reports/total-budget:
    get:
      tags:
        - Reports
      summary: Get total budget limit
      responses:
        '200':
          description: Total budget
          content:
            application/json:
              schema:
                type: object
                properties:
                  budget_limit:
                    type: number
    post:
      tags:
        - Budgets
      summary: Set total budget limit
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - budget_limit
              properties:
                budget_limit:
                  type: number
      responses:
        '200':
          description: Total budget set
    put:
      tags:
        - Budgets
      summary: Update total budget limit
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - budget_limit
              properties:
                budget_limit:
                  type: number
      responses:
        '200':
          description: Total budget updated
    delete:
      tags:
        - Budgets
      summary: Delete total budget
      responses:
        '200':
          description: Total budget deleted

  /chat:
    post:
      tags:
        - Chat
      summary: Chat with financial AI assistant
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/AIChatRequest'
      responses:
        '200':
          description: AI response
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AIChatResponse'

  /chat/stream:
    post:
      tags:
        - Chat
      summary: Chat with financial AI assistant (streaming)
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/AIChatRequest'
      responses:
        '200':
          description: SSE stream of AI response
          content:
            text/event-stream:
              schema:
                type: string

  /chat/messages:
    get:
      tags:
        - Chat
      summary: Get chat messages
      parameters:
        - name: sessionId
          in: query
          required: true
          schema:
            type: string
      responses:
        '200':
          description: List of messages
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/ChatMessage'

  /chat/history:
    get:
      tags:
        - Chat
      summary: Get chat history (sessions)
      responses:
        '200':
          description: List of sessions
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/ChatSession'

  /chat/history/{id}:
    get:
      tags:
        - Chat
      summary: Get a chat session
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Session details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ChatSession'
        '404':
          description: Session not found
    delete:
      tags:
        - Chat
      summary: Delete chat session
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Deleted
        '404':
          description: Session not found

  /settings:
    get:
      tags:
        - Settings
      summary: Get all settings
      parameters:
        - name: key
          in: query
          description: Get a specific setting by key
          schema:
            type: string
      responses:
        '200':
          description: Application settings
          content:
            application/json:
              schema:
                type: object
                properties:
                  settings:
                    type: object
                    additionalProperties: true
                  descriptions:
                    type: object
                    additionalProperties:
                      type: string
    put:
      tags:
        - Settings
      summary: Update settings
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - settings
              properties:
                settings:
                  type: object
                  additionalProperties: true
      responses:
        '200':
          description: Settings updated

  /ping:
    get:
      tags:
        - Settings
      summary: Health check
      description: Check database connectivity
      responses:
        '200':
          description: Service is healthy
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    example: ok

  /check-version:
    get:
      tags:
        - Settings
      summary: Check for updates
      description: Check GitHub for latest release version
      responses:
        '200':
          description: Version info
          content:
            application/json:
              schema:
                type: object
                properties:
                  currentVersion:
                    type: string
                  latestVersion:
                    type: string
                  updateAvailable:
                    type: boolean

  /migrate:
    get:
      tags:
        - Maintenance
      summary: Check migration status
      responses:
        '200':
          description: Migration status
    post:
      tags:
        - Maintenance
      summary: Run database migrations
      responses:
        '200':
          description: Migrations completed

  /mcp:
    get:
      tags:
        - Settings
      summary: Establish MCP SSE connection
      description: Server-Sent Events connection for Model Context Protocol
      responses:
        '200':
          description: SSE stream
          content:
            text/event-stream:
              schema:
                type: string
    post:
      tags:
        - Settings
      summary: Send message to MCP server
      parameters:
        - name: sessionId
          in: query
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
      responses:
        '202':
          description: Accepted
        '404':
          description: Session not found

  /whatsapp/status:
    get:
      tags:
        - WhatsApp
      summary: Get WhatsApp connection status
      responses:
        '200':
          description: WhatsApp status and QR code
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/WhatsAppStatus'
    post:
      tags:
        - WhatsApp
      summary: Control WhatsApp client
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - action
              properties:
                action:
                  type: string
                  enum: [connect, restart, disconnect, renew_qr]
      responses:
        '200':
          description: Action performed

  /whatsapp-test:
    post:
      tags:
        - WhatsApp
      summary: Test WhatsApp integration
      description: Generate and send a test WhatsApp message
      responses:
        '200':
          description: Test completed
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  message:
                    type: string

  /debug/screenshots:
    get:
      tags:
        - Debug
      summary: List debug screenshots
      responses:
        '200':
          description: List of screenshots
          content:
            application/json:
              schema:
                type: array
                items:
                  type: object
                  properties:
                    filename:
                      type: string
                    timestamp:
                      type: string
    delete:
      tags:
        - Debug
      summary: Delete all debug screenshots
      responses:
        '200':
          description: Screenshots deleted

  /debug/take_screenshot:
    post:
      tags:
        - Debug
      summary: Take a screenshot
      description: Manually capture current scraper browser screenshot
      responses:
        '200':
          description: Screenshot taken
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  filename:
                    type: string

  /debug/view_image:
    get:
      tags:
        - Debug
      summary: View a debug image
      parameters:
        - name: filename
          in: query
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Image file
          content:
            image/png:
              schema:
                type: string
                format: binary

  /maintenance/database/export:
    get:
      tags:
        - Maintenance
      summary: Export database
      responses:
        '200':
          description: Database backup JSON
          content:
            application/json:
              schema:
                type: object

  /maintenance/database/import:
    post:
      tags:
        - Maintenance
      summary: Import database
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                data:
                  type: object
                mode:
                  type: string
                  enum: [replace, merge]
      responses:
        '200':
          description: Import result

components:
  schemas:
    Transaction:
      type: object
      properties:
        identifier:
          type: string
        vendor:
          type: string
        date:
          type: string
          format: date
        name:
          type: string
        price:
          type: number
        category:
          type: string
        type:
          type: string
        processed_date:
          type: string
          format: date
        original_amount:
          type: number
        original_currency:
          type: string
        charged_currency:
          type: string
        memo:
          type: string
        status:
          type: string
        installments_number:
          type: integer
        installments_total:
          type: integer
        account_number:
          type: string
        category_source:
          type: string
        rule_matched:
          type: string
        transaction_type:
          type: string
          enum: [bank, credit_card]

    Account:
      type: object
      properties:
        id:
          type: integer
        vendor:
          type: string
        account_number:
          type: string
        balance:
          type: number
          nullable: true
        balance_updated_at:
          type: string
          format: date-time
          nullable: true
        nickname:
          type: string
        credential:
          type: object
          properties:
            id:
              type: integer
            vendor:
              type: string
            nickname:
              type: string

    Budget:
      type: object
      properties:
        id:
          type: integer
        category:
          type: string
        budget_limit:
          type: number
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time

    CategorizationRule:
      type: object
      properties:
        id:
          type: integer
        name_pattern:
          type: string
        target_category:
          type: string
        is_active:
          type: boolean
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time

    CategoryMapping:
      type: object
      properties:
        id:
          type: integer
        source_category:
          type: string
        target_category:
          type: string
        created_at:
          type: string
          format: date-time

    CardVendor:
      type: object
      properties:
        id:
          type: integer
        last4_digits:
          type: string
        card_vendor:
          type: string
        card_nickname:
          type: string
        transaction_count:
          type: integer
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time

    CardOwnership:
      type: object
      properties:
        id:
          type: integer
        vendor:
          type: string
        account_number:
          type: string
        linked_bank_account_id:
          type: integer
        custom_bank_account_number:
          type: string
        custom_bank_account_nickname:
          type: string

    Credential:
      type: object
      properties:
        id:
          type: integer
        vendor:
          type: string
        username:
          type: string
        id_number:
          type: string
        card6_digits:
          type: string
        nickname:
          type: string
        bank_account_number:
          type: string
        is_active:
          type: boolean
        created_at:
          type: string
          format: date-time
        last_synced_at:
          type: string
          format: date-time

    CredentialInput:
      type: object
      required:
        - vendor
      properties:
        vendor:
          type: string
        username:
          type: string
        password:
          type: string
        id_number:
          type: string
        card6_digits:
          type: string
        nickname:
          type: string
        bank_account_number:
          type: string
        is_active:
          type: boolean
          default: true

    ScrapeRequest:
      type: object
      required:
        - options
        - credentials
        - credentialId
      properties:
        options:
          type: object
          required:
            - companyId
            - startDate
          properties:
            companyId:
              type: string
            startDate:
              type: string
              format: date
            showBrowser:
              type: boolean
        credentials:
          type: object
        credentialId:
          type: integer

    ScrapeEvent:
      type: object
      properties:
        id:
          type: integer
        triggered_by:
          type: string
        vendor:
          type: string
        status:
          type: string
          enum: [started, completed, success, failed, error, cancelled]
        message:
          type: string
        created_at:
          type: string
          format: date-time
        duration_seconds:
          type: number

    ScrapeReport:
      type: object
      properties:
        processedTransactions:
          type: array
          items:
            type: object
        savedTransactions:
          type: integer
        duration_seconds:
          type: number

    SyncAllRequest:
      type: object
      properties:
        daysBack:
          type: integer
          default: 30

    SyncStatusResponse:
      type: object
      properties:
        syncHealth:
          type: string
          enum: [healthy, stale, outdated, error, syncing, no_accounts, never_synced, unknown]
        settings:
          type: object
          properties:
            enabled:
              type: boolean
            syncHour:
              type: integer
            daysBack:
              type: integer
        activeAccounts:
          type: integer
        latestScrape:
          $ref: '#/components/schemas/ScrapeEvent'
        history:
          type: array
          items:
            $ref: '#/components/schemas/ScrapeEvent'
        accountSyncStatus:
          type: array
          items:
            type: object

    InstallmentDetail:
      type: object
      properties:
        name:
          type: string
        price:
          type: number
        original_amount:
          type: number
        original_currency:
          type: string
        category:
          type: string
        vendor:
          type: string
        account_number:
          type: string
        current_installment:
          type: integer
        total_installments:
          type: integer
        last_charge_date:
          type: string
          format: date
        next_payment_date:
          type: string
          format: date
        status:
          type: string
          enum: [active, completed]

    RecurringPaymentDetail:
      type: object
      properties:
        name:
          type: string
        monthly_amount:
          type: number
        price:
          type: number
        category:
          type: string
        vendor:
          type: string
        account_number:
          type: string
        month_count:
          type: integer
        last_charge_date:
          type: string
          format: date
        frequency:
          type: string
          enum: [monthly, bi-monthly]
        next_payment_date:
          type: string
          format: date

    NonRecurringExclusion:
      type: object
      properties:
        id:
          type: integer
        name:
          type: string
        account_number:
          type: string
          nullable: true
        created_at:
          type: string
          format: date-time

    AIChatRequest:
      type: object
      required:
        - message
      properties:
        message:
          type: string
        context:
          type: object
        sessionId:
          type: string

    AIChatResponse:
      type: object
      properties:
        response:
          type: string
        success:
          type: boolean
        model:
          type: string

    ChatSession:
      type: object
      properties:
        id:
          type: string
        title:
          type: string
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time

    ChatMessage:
      type: object
      properties:
        id:
          type: integer
        role:
          type: string
          enum: [user, assistant]
        content:
          type: string
        timestamp:
          type: string
          format: date-time

    WhatsAppStatus:
      type: object
      properties:
        status:
          type: string
          enum: [DISCONNECTED, INITIALIZING, QR_READY, AUTHENTICATED, READY]
        qr:
          type: string
          nullable: true
        timestamp:
          type: string
          format: date-time

  responses:
    BadRequest:
      description: Bad request
      content:
        application/json:
          schema:
            type: object
            properties:
              error:
                type: string
    InternalError:
      description: Internal server error
      content:
        application/json:
          schema:
            type: object
            properties:
              error:
                type: string
              details:
                type: string
